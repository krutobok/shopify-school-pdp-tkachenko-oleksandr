<section class="py-6 bg-background" id="MainProduct-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="container-fluid">
    <nav class="body-medium flex items-center gap-2 text-secondary mb-4" aria-label="Breadcrumb">
      <a href="{{ routes.root_url }}" class="hover:text-foreground transition-colors"> {{ 'product.home' | t }} </a>
      <span aria-hidden="true">/</span>
      {% if collection %}
        <a href="{{ collection.url }}" class="hover:text-foreground transition-colors">{{ collection.title }}</a>
        <span aria-hidden="true">/</span>
      {% endif %}
      <span class="text-foreground cursor-default">
        {% if section.settings.remove_color_from_breadcrumbs %}
          {{ product.title | split: ' - ' | first }}
        {% else %}
          {{ product.title }}
        {% endif %}
      </span>
    </nav>

    <div class="flex items-stretch gap-6 flex-col md:items-center xl:items-start xl:gap-14 xl:flex-row">
      <div class="flex flex-col-reverse gap-4 shrink-0 md:flex-row md:gap-6">
        <div class="flex gap-4 justify-start overflow-x-auto mr-mobile-thumbnails md:justify-between md:flex-col md:gap-0 md:overflow-x-visible md:mr-0">
          {% for image in product.images %}
            {%- capture main_image_srcset -%}
              {{ image | image_url: width: 375 }} 375w,
              {{ image | image_url: width: 550 }} 550w,
              {{ image | image_url: width: 750 }} 750w,
              {{ image | image_url: width: 1100 }} 1100w,
              {{ image | image_url: width: 1500 }} 1500w
            {%- endcapture -%}

            {% assign is_active = false %}
            {% if product.selected_or_first_available_variant.featured_media.id == image.id %}
              {% assign is_active = true %}
            {% elsif product.selected_or_first_available_variant.featured_media == blank and forloop.first %}
              {% assign is_active = true %}
            {% endif %}

            <button
              class="
                gallery-thumb-btn w-22 h-22 shrink-0 border-none p-0 rounded-lg
                aria-selected:relative
                aria-selected:before:absolute
                aria-selected:before:inset-0
                aria-selected:before:z-10
                aria-selected:before:rounded-lg
                aria-selected:before:bg-foreground
                aria-selected:before:opacity-20
              "
              data-src="{{ image.src | image_url: width: 1072 }}"
              data-srcset="{{ main_image_srcset | strip }}"
              data-media-id="{{ image.id }}"
              type="button"
              aria-selected="{{ is_active }}"
            >
              {% assign thumb_image_alt = image.alt
                | default: product.title
                | append: ' - Image '
                | append: forloop.index
                | escape
              %}
              {{
                image
                | image_url: width: 176, height: 176, crop: 'center'
                | image_tag:
                  class: 'w-22 h-22 rounded-lg cursor-pointer',
                  widths: '88, 176',
                  sizes: '88px',
                  loading: 'lazy',
                  alt: thumb_image_alt
              }}
            </button>
          {% endfor %}
        </div>

        <div class="max-w-134 relative w-full">
          {% render 'product-badge', product: product, class: 'absolute top-4 left-4' %}
          {% assign main_image = product.featured_image %}
          {% if main_image != blank %}
            {% assign main_image_id = 'MainImage-' | append: section.id %}
            {% assign image_alt = main_image.alt | default: product.title | default: ' - Selected image' | escape %}
            {{
              main_image
              | image_url: width: 1072, height: 1072, crop: 'center'
              | image_tag:
                id: main_image_id,
                alt: image_alt,
                class: 'max-w-134 w-full rounded-lg aspect-square',
                widths: '320, 375, 450, 536, 640, 750, 900, 1072',
                sizes: '(min-width: 568px) 536px, calc(100vw - 32px - 15px)',
                fetchpriority: 'high'
            }}
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-contain object-center bg-gray-200' }}
          {% endif %}
        </div>
      </div>

      <div class="flex flex-col space-between">
        <div>
          <h1 class="text-h2 mb-2">
            {% if section.settings.remove_color_from_title %}
              {{ product.title | split: ' - ' | first }}
            {% else %}
              {{ product.title }}
            {% endif %}
          </h1>
          {% if section.settings.show_rating %}
            <div class="mb-3">
              {% render 'stars-rating', product: product, show_text: true %}
            </div>
          {% endif %}
        </div>

        <div class="prose body-medium text-secondary mb-6">
          {{ product.description }}
        </div>

        <div class="body-large flex gap-1.5 mb-6">
          {% if product.selected_or_first_available_variant.compare_at_price
              > product.selected_or_first_available_variant.price
          %}
            <s class="text-secondary">{{ product.selected_or_first_available_variant.compare_at_price | money }}</s>
          {% endif %}
          <span class="text-foreground">{{ product.selected_or_first_available_variant.price | money }}</span>
        </div>

        {% assign product_form_id = 'product-form-' | append: section.id %}
        {% form 'product', product, id: product_form_id, class: 'flex flex-col justify-between mb-6' %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          {% assign related_colors = product.metafields.custom.related_colors.value %}
          {% if related_colors != blank %}
            <div class="selector-wrapper mb-6">
              <div class="flex gap-2">
                {% for color_prod in related_colors %}
                  <a
                    href="{{ color_prod.url }}"
                    class="color-swatch-link w-22 h-22 rounded-lg border overflow-hidden transition-all hover:opacity-80 block {% if color_prod.handle == product.handle %} border-foreground {% else %} border-transparent bg-[#F5F5F5] {% endif %}"
                    title="{{ color_prod.title }}"
                    aria-label="{{ 'product.change_color_to' | t: color: color_prod.title }}"
                    {% if color_prod.handle == product.handle %}
                      aria-current="true"
                    {% endif %}
                  >
                    {% assign color_image_alt = color_prod.featured_image.alt | default: color_prod.title | escape %}
                    {{
                      color_prod.featured_image
                      | image_url: width: 176, height: 176, crop: 'center'
                      | image_tag:
                        class: 'w-22 h-22 rounded-lg pointer-events-none',
                        widths: '88, 176',
                        sizes: '88px',
                        loading: 'lazy',
                        alt: color_image_alt
                    }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% unless product.has_only_default_variant %}
            <div class="selector-wrapper mb-6 md:mb-8">
              <div class="flex justify-between items-center mb-3 body-medium">
                <label>{{ 'product.select_size' | t }}</label>
                <button type="button" class="underline">{{ 'product.size_guide' | t }}</button>
              </div>

              {% liquid
                assign size_index = 0
                for option in product.options
                  assign option_downcased = option | downcase
                  if option_downcased contains 'size' or option_downcased contains 'розмір'
                    assign size_index = forloop.index0
                  endif
                endfor
              %}

              <div class="grid gap-2 grid-cols-2 md:grid-cols-3">
                {% for variant in product.variants %}
                  <label class="cursor-pointer group">
                    <input
                      type="radio"
                      name="id"
                      value="{{ variant.id }}"
                      id="variant-radio-{{ variant.id }}"
                      class="peer sr-only variant-radio"
                      {% if product.selected_or_first_available_variant.id == variant.id %}
                        checked
                      {% endif %}
                      {% unless variant.available %}
                        disabled
                      {% endunless %}
                    >
                    <div
                      class="
                        btn btn-outline w-full body-medium! uppercase!
                        peer-checked:border-foreground
                        peer-focus-visible:ring-2 peer-focus-visible:ring-foreground
                        peer-disabled:bg-gray-100 peer-disabled:border-gray-200 peer-disabled:text-gray-400 peer-disabled:cursor-not-allowed
                      "
                    >
                      {{ variant.options[size_index] }}
                    </div>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endunless %}

          <div>
            {%- liquid
              if product.selected_or_first_available_variant.available
                assign button_text = 'product.add_to_cart' | t
                assign is_disabled = false
              else
                assign button_text = 'product.sold_out' | t
                assign is_disabled = true
              endif
            -%}

            {% render 'button',
              type: 'submit',
              name: 'add',
              text: button_text,
              class: 'w-full',
              disabled: is_disabled,
              variant: 'primary'
            %}
          </div>
        {% endform %}
        {% if section.blocks.size > 0 %}
          <div class="flex flex-col gap-3 mb-6">
            {% for block in section.blocks %}
              {% case block.type %}
                {% when 'service_text' %}
                  <div class="flex items-center gap-1.5 body-medium text-foreground" {{ block.shopify_attributes }}>
                    {% if block.settings.icon_svg != blank %}
                      <div
                        class="w-5 h-5 shrink-0 flex items-center justify-center [&>svg]:w-full [&>svg]:h-full"
                        aria-hidden="true"
                      >
                        {{ block.settings.icon_svg }}
                      </div>
                    {% endif %}
                    <span>{{ block.settings.text }}</span>
                  </div>
              {% endcase %}
            {% endfor %}
          </div>
        {% endif %}
        {% assign product_note = product.metafields.custom.product_note %}
        {% if product_note != blank %}
          <div class="body-medium text-secondary">
            {{ product_note }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  class MainProduct {
    constructor(sectionId) {
      this.sectionId = sectionId;
      this.init();
    }

    init() {
      this.section = document.getElementById(`MainProduct-${this.sectionId}`);
      if (!this.section) return;

      this.mainImage = document.getElementById(`MainImage-${this.sectionId}`);

      this.section.querySelectorAll('.gallery-thumb-btn').forEach((btn) => {
        btn.addEventListener('click', () => this.handleGalleryClick(btn));
      });

      this.section.querySelectorAll('.variant-radio').forEach((radio) => {
        radio.addEventListener('change', (e) => this.handleVariantChange(e));
      });

      this.section.querySelectorAll('.color-swatch-link').forEach((link) => {
        link.addEventListener('click', (e) => this.handleColorChange(e));
      });
    }

    handleGalleryClick(btn) {
      if (!this.mainImage) return;

      const allThumbs = this.section.querySelectorAll('.gallery-thumb-btn');
      allThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));
      btn.setAttribute('aria-selected', 'true');

      const newSrc = btn.dataset.src;
      const newSrcset = btn.dataset.srcset;

      if (newSrc) {
        this.mainImage.src = newSrc;
        if (newSrcset) {
          this.mainImage.srcset = newSrcset;
        } else {
          this.mainImage.removeAttribute('srcset');
        }
      }
    }

    handleVariantChange(e) {
      const variantId = e.target.value;
      const url = new URL(window.location);
      url.searchParams.set('variant', variantId);
      window.history.replaceState({}, '', url);

      this.fetchSection(url.toString(), true);
    }

    handleColorChange(e) {
      e.preventDefault();
      const link = e.target.closest('a');
      if (!link) return;

      const url = link.href;
      window.history.pushState({}, '', url);

      this.fetchSection(url, false);
    }

    fetchSection(url, keepImage = false) {
      const fetchUrl = new URL(url);
      fetchUrl.searchParams.set('section_id', this.section.dataset.sectionId);

      this.section.style.opacity = '0.5';

      let currentImageState = null;
      let activeMediaId = null;

      if (keepImage && this.mainImage) {
        currentImageState = {
          src: this.mainImage.src,
          srcset: this.mainImage.srcset,
        };
        const activeBtn = this.section.querySelector('.gallery-thumb-btn[aria-selected="true"]');
        if (activeBtn) {
          activeMediaId = activeBtn.dataset.mediaId;
        }
      }

      fetch(fetchUrl)
        .then((response) => response.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newSectionContent = doc.getElementById(`MainProduct-${this.sectionId}`);

          if (newSectionContent) {
            if (keepImage && currentImageState) {
              const newMainImage = newSectionContent.querySelector(`#MainImage-${this.sectionId}`);
              if (newMainImage) {
                newMainImage.setAttribute('src', currentImageState.src);
                if (currentImageState.srcset) {
                  newMainImage.setAttribute('srcset', currentImageState.srcset);
                } else {
                  newMainImage.removeAttribute('srcset');
                }
              }

              if (activeMediaId) {
                const newThumbs = newSectionContent.querySelectorAll('.gallery-thumb-btn');
                newThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));

                const targetThumb = newSectionContent.querySelector(
                  `.gallery-thumb-btn[data-media-id="${activeMediaId}"]`
                );
                if (targetThumb) {
                  targetThumb.setAttribute('aria-selected', 'true');
                }
              }
            }

            this.section.innerHTML = newSectionContent.innerHTML;
            this.init();
            const variantId = fetchUrl.searchParams.get('variant');
            document.getElementById(`variant-radio-${variantId}`).focus();
          }
        })
        .catch((err) => console.error('Error fetching section:', err))
        .finally(() => {
          this.section.style.opacity = '1';
        });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new MainProduct('{{ section.id }}');
  });
</script>

{% schema %}
{
  "name": "Main Product",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show star rating",
      "default": true
    },
    {
      "type": "header",
      "content": "Title Formatting"
    },
    {
      "type": "checkbox",
      "id": "remove_color_from_title",
      "label": "Remove color from title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "remove_color_from_breadcrumbs",
      "label": "Remove color from breadcrumbs",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "service_text",
      "name": "Service Benefit",
      "settings": [
        {
          "type": "inline_richtext",
          "id": "text",
          "label": "Text",
          "default": "Benefit text here"
        },
        {
          "type": "html",
          "id": "icon_svg",
          "label": "SVG Icon Code",
          "info": "Paste the SVG code here. Ensure it has width/height or viewBox."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product",
      "blocks": [
        {
          "type": "service_text",
          "settings": {
            "text": "Free U.S. Shipping Over $150",
            "icon_svg": "<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M12.9814 2.81833L14.6481 3.69295C16.4412 4.63391 17.3377 5.10438 17.8355 5.9498C18.3334 6.79523 18.3334 7.84724 18.3334 9.95128V10.0488C18.3334 12.1528 18.3334 13.2048 17.8355 14.0502C17.3377 14.8957 16.4412 15.3661 14.6481 16.3071L12.9814 17.1817C11.5184 17.9495 10.7869 18.3334 10 18.3334C9.21313 18.3334 8.48162 17.9495 7.0186 17.1817L5.35193 16.3071C3.55888 15.3661 2.66235 14.8957 2.16452 14.0502C1.66669 13.2048 1.66669 12.1528 1.66669 10.0488V9.95128C1.66669 7.84724 1.66669 6.79523 2.16452 5.9498C2.66235 5.10438 3.55888 4.63391 5.35193 3.69295L7.0186 2.81832C8.48162 2.05057 9.21313 1.66669 10 1.66669C10.7869 1.66669 11.5184 2.05057 12.9814 2.81833Z' stroke='#111111' stroke-linecap='round'/><path d='M17.5 6.25L14.1667 7.91667M10 10L2.5 6.25M10 10V17.9167M10 10C10 10 12.2855 8.85723 13.75 8.125C13.9127 8.04364 14.1667 7.91667 14.1667 7.91667M14.1667 7.91667V10.8333M14.1667 7.91667L6.25 3.75' stroke='#111111' stroke-linecap='round'/></svg>"
          }
        },
        {
          "type": "service_text",
          "settings": {
            "text": "Safe & Secure Checkout",
            "icon_svg": "<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M1.66669 9.99998C1.66669 6.85728 1.66669 5.28593 2.643 4.30962C3.61931 3.33331 5.19066 3.33331 8.33335 3.33331H11.6667C14.8094 3.33331 16.3807 3.33331 17.357 4.30962C18.3334 5.28593 18.3334 6.85728 18.3334 9.99998C18.3334 13.1427 18.3334 14.714 17.357 15.6903C16.3807 16.6666 14.8094 16.6666 11.6667 16.6666H8.33335C5.19066 16.6666 3.61931 16.6666 2.643 15.6903C1.66669 14.714 1.66669 13.1427 1.66669 9.99998Z' stroke='#111111'/><path d='M8.33333 13.75H5' stroke='#111111' stroke-linecap='round'/><path d='M6.66667 11.25H5' stroke='#111111' stroke-linecap='round'/><path d='M1.66669 8.33331L18.3334 8.33331' stroke='#111111' stroke-linecap='round'/><path d='M11.6667 12.5C11.6667 11.7143 11.6667 11.3215 11.9108 11.0774C12.1548 10.8333 12.5477 10.8333 13.3334 10.8333C14.119 10.8333 14.5119 10.8333 14.7559 11.0774C15 11.3215 15 11.7143 15 12.5C15 13.2857 15 13.6785 14.7559 13.9226C14.5119 14.1666 14.119 14.1666 13.3334 14.1666C12.5477 14.1666 12.1548 14.1666 11.9108 13.9226C11.6667 13.6785 11.6667 13.2857 11.6667 12.5Z' stroke='#111111'/></svg>"
          }
        },
        {
          "type": "service_text",
          "settings": {
            "text": "Afterpay available at checkout",
            "icon_svg": "<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M16.7531 6.17558L11.9966 3.52396C10.6003 2.74563 8.85517 3.71826 8.85517 5.27608V5.5481C8.85517 5.79384 8.99107 6.02128 9.21112 6.14357L10.1093 6.64418C10.373 6.79162 10.702 6.60761 10.702 6.31387V5.63725C10.702 5.29894 11.0809 5.0875 11.3837 5.25666L15.5035 7.55396C15.8068 7.72311 15.8068 8.146 15.5035 8.31403L11.3837 10.6113C11.0809 10.7805 10.702 10.569 10.702 10.2307V9.87067C10.702 8.31286 8.95687 7.33909 7.55962 8.11855L2.80312 10.7702C1.40677 11.5485 1.40677 13.4961 2.80312 14.2744L7.55962 16.926C8.95552 17.7044 10.702 16.7317 10.702 15.1739V14.9019C10.702 14.6561 10.5661 14.4298 10.346 14.3064L9.44782 13.8047C9.18412 13.6572 8.85517 13.8412 8.85517 14.135V14.8116C8.85517 15.1499 8.47672 15.3613 8.17342 15.1922L4.05367 12.8949C3.75082 12.7257 3.75082 12.3029 4.05367 12.1337L8.17342 9.83638C8.47672 9.66722 8.85517 9.87868 8.85517 10.217V10.577C8.85517 12.1348 10.6003 13.1086 11.9966 12.3292L16.7531 9.67753C18.1495 8.90146 18.1495 6.95391 16.7531 6.17558Z' fill='#111111'/></svg>"
          }
        }
      ]
    }
  ]
}
{% endschema %}

{%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 757px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

  .swiper.thumb-swiper.swiper-initialized{
    margin: 0!important;
  }
{%- endstyle -%}

<section
  class="section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} bg-background"
  id="MainProduct-{{ section.id }}"
  data-section-id="{{ section.id }}"
>
  <div class="container-fluid">
    <nav class="body-medium flex items-center gap-2 text-secondary mb-4" aria-label="Breadcrumb">
      <a href="{{ routes.root_url }}" class="hover:text-foreground transition-colors"> {{ 'product.home' | t }} </a>
      <span aria-hidden="true">/</span>
      {% if collection %}
        <a href="{{ collection.url }}" class="hover:text-foreground transition-colors">{{ collection.title }}</a>
        <span aria-hidden="true">/</span>
      {% endif %}
      <span class="text-foreground cursor-default">
        {% if section.settings.remove_color_from_breadcrumbs %}
          {{ product.title | split: ' - ' | first }}
        {% else %}
          {{ product.title }}
        {% endif %}
      </span>
    </nav>

    <div class="flex items-stretch gap-6 flex-col md:items-start xl:items-start xl:gap-14 xl:flex-row">
      <div class="flex flex-col-reverse gap-4 md:mr-auto md:ml-auto xl:mr-auto xl:ml-auto shrink-0 md:max-w-162 md:justify-center md:flex-row md:gap-6 w-full xl:w-auto">
        {% assign enable_slider = false %}
        {% if product.images.size > 2 %}
          {% assign enable_slider = true %}
        {% endif %}

        <div class="thumbnails-wrapper max-w-134 md:max-w-auto md:max-h-134 my-0! {% if enable_slider %}swiper thumb-swiper{% else %}flex gap-4 justify-start overflow-x-auto mr-mobile-thumbnails md:justify-between md:flex-col md:gap-6 md:overflow-x-visible md:mr-0{% endif %}">
          {% if enable_slider %}<div class="swiper-wrapper">{% endif %}
          {% for image in product.images %}
            {%- capture main_image_srcset -%}
                {{ image | image_url: width: 375 }} 375w,
                {{ image | image_url: width: 550 }} 550w,
                {{ image | image_url: width: 750 }} 750w,
                {{ image | image_url: width: 1100 }} 1100w,
                {{ image | image_url: width: 1500 }} 1500w
              {%- endcapture -%}

            {% assign is_active = false %}
            {% if product.selected_or_first_available_variant.featured_media.id == image.id %}
              {% assign is_active = true %}
            {% elsif product.selected_or_first_available_variant.featured_media == blank and forloop.first %}
              {% assign is_active = true %}
            {% endif %}

            {% if enable_slider %}<div class="swiper-slide h-auto! w-auto!">{% endif %}
            <button
              class="
                gallery-thumb-btn w-22 h-22 shrink-0 border-none p-0 rounded-lg block
                aria-selected:relative
                aria-selected:before:absolute
                aria-selected:before:inset-0
                aria-selected:before:z-10
                aria-selected:before:rounded-lg
                aria-selected:before:bg-foreground
                aria-selected:before:opacity-20
                {% unless enable_slider %}mb-4 md:mb-0{% endunless %}
              "
              data-src="{{ image.src | image_url: width: 1072 }}"
              data-srcset="{{ main_image_srcset | strip }}"
              data-media-id="{{ image.id }}"
              {% if enable_slider %}
                data-slide-index="{{ forloop.index0 }}"
              {% endif %}
              type="button"
              aria-selected="{{ is_active }}"
            >
              {% assign thumb_image_alt = image.alt
                | default: product.title
                | append: ' - Image '
                | append: forloop.index
                | escape
              %}
              {{
                image
                | image_url: width: 176, height: 176, crop: 'center'
                | image_tag:
                  class: 'w-22 h-22 rounded-lg cursor-pointer block',
                  widths: '88, 176',
                  sizes: '88px',
                  loading: 'lazy',
                  alt: thumb_image_alt
              }}
            </button>
            {% if enable_slider %}</div>{% endif %}
          {% endfor %}
          {% if enable_slider %}</div>{% endif %}
        </div>

        <div class="max-w-134 relative w-full">
          {% render 'product-badge', product: product, class: 'absolute top-4 left-4' %}
          {% assign main_image = product.featured_image %}
          {% if main_image != blank %}
            {% assign main_image_id = 'MainImage-' | append: section.id %}
            {% assign image_alt = main_image.alt | default: product.title | default: ' - Selected image' | escape %}
            {{
              main_image
              | image_url: width: 1072, height: 1072, crop: 'center'
              | image_tag:
                id: main_image_id,
                alt: image_alt,
                class: 'max-w-134 w-full md:w-134 rounded-lg aspect-square object-cover',
                widths: '320, 375, 450, 536, 640, 750, 900, 1072',
                sizes: '(min-width: 568px) 536px, calc(100vw - 32px - 15px)',
                fetchpriority: 'high'
            }}
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-contain object-center bg-gray-200' }}
          {% endif %}
        </div>
      </div>

      <div class="flex flex-col space-between w-full">
        <div>
          <h1 class="text-h2 mb-2">
            {% if section.settings.remove_color_from_title %}
              {{ product.title | split: ' - ' | first }}
            {% else %}
              {{ product.title }}
            {% endif %}
          </h1>
          {% if section.settings.show_rating %}
            <div class="mb-3">
              {% render 'stars-rating', type: 'average', product: product, show_text: true %}
            </div>
          {% endif %}
        </div>

        <div class="prose body-medium text-secondary mb-6">
          {{ product.description }}
        </div>

        <div class="body-large flex gap-1.5 mb-6">
          {% if product.selected_or_first_available_variant.compare_at_price
              > product.selected_or_first_available_variant.price
          %}
            <s class="text-secondary">{{ product.selected_or_first_available_variant.compare_at_price | money }}</s>
          {% endif %}
          <span class="text-foreground">{{ product.selected_or_first_available_variant.price | money }}</span>
        </div>

        {% assign product_form_id = 'product-form-' | append: section.id %}
        {% form 'product', product, id: product_form_id, class: 'flex flex-col justify-between mb-6' %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          {% assign related_colors = product.metafields.custom.related_colors.value %}
          {% if related_colors != blank %}
            <div class="selector-wrapper mb-6">
              <div class="flex gap-2">
                {% for color_prod in related_colors %}
                  <a
                    href="{{ color_prod.url }}"
                    class="color-swatch-link w-22 h-22 rounded-lg border overflow-hidden transition-all hover:opacity-80 block {% if color_prod.handle == product.handle %} border-foreground {% else %} border-transparent bg-[#F5F5F5] {% endif %}"
                    title="{{ color_prod.title }}"
                    aria-label="{{ 'product.change_color_to' | t: color: color_prod.title }}"
                    {% if color_prod.handle == product.handle %}
                      aria-current="true"
                    {% endif %}
                  >
                    {% assign color_image_alt = color_prod.featured_image.alt | default: color_prod.title | escape %}
                    {{
                      color_prod.featured_image
                      | image_url: width: 176, height: 176, crop: 'center'
                      | image_tag:
                        class: 'w-22 h-22 rounded-lg pointer-events-none',
                        widths: '88, 176',
                        sizes: '88px',
                        loading: 'lazy',
                        alt: color_image_alt
                    }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% unless product.has_only_default_variant %}
            <div class="selector-wrapper mb-6 md:mb-8">
              <div class="flex justify-between items-center mb-3 body-medium">
                <label>{{ 'product.select_size' | t }}</label>
                <button type="button" class="underline">{{ 'product.size_guide' | t }}</button>
              </div>

              {% liquid
                assign size_index = 0
                for option in product.options
                  assign option_downcased = option | downcase
                  if option_downcased contains 'size' or option_downcased contains 'розмір'
                    assign size_index = forloop.index0
                  endif
                endfor
              %}

              <div class="grid gap-2 grid-cols-2 md:grid-cols-3">
                {% for variant in product.variants %}
                  <label class="cursor-pointer group">
                    <input
                      type="radio"
                      name="id"
                      value="{{ variant.id }}"
                      id="variant-radio-{{ variant.id }}"
                      class="peer sr-only variant-radio"
                      {% if product.selected_or_first_available_variant.id == variant.id %}
                        checked
                      {% endif %}
                      {% unless variant.available %}
                        disabled
                      {% endunless %}
                    >
                    <div
                      class="
                        btn btn-outline w-full body-medium! uppercase!
                        peer-checked:border-foreground
                        peer-focus-visible:ring-2 peer-focus-visible:ring-foreground
                        peer-disabled:bg-gray-100 peer-disabled:border-gray-200 peer-disabled:text-gray-400 peer-disabled:cursor-not-allowed
                      "
                    >
                      {{ variant.options[size_index] }}
                    </div>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endunless %}

          <div>
            {%- liquid
              if product.selected_or_first_available_variant.available
                assign button_text = 'product.add_to_cart' | t
                assign is_disabled = false
              else
                assign button_text = 'product.sold_out' | t
                assign is_disabled = true
              endif
            -%}

            {% render 'button',
              type: 'submit',
              name: 'add',
              text: button_text,
              class: 'btn-primary w-full',
              disabled: is_disabled,
              variant: 'primary'
            %}
          </div>
        {% endform %}

        {% assign service_blocks = section.blocks | where: 'type', 'service_text' %}
        {% if service_blocks.size > 0 %}
          <div class="flex flex-col gap-3 mb-6">
            {% for block in service_blocks %}
              <div class="flex items-center gap-1.5 body-medium text-foreground" {{ block.shopify_attributes }}>
                {% if block.settings.icon_svg != blank %}
                  <div
                    class="w-5 h-5 shrink-0 flex items-center justify-center [&>svg]:w-full [&>svg]:h-full"
                    aria-hidden="true"
                  >
                    {{ block.settings.icon_svg }}
                  </div>
                {% endif %}
                <span>{{ block.settings.text }}</span>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% assign product_note = product.metafields.custom.product_note %}
        {% if product_note != blank %}
          <div class="body-medium text-secondary">
            {{ product_note }}
          </div>
        {% endif %}

        {% assign accordion_block = section.blocks | where: 'type', 'accordion_group' | first %}
        {% if accordion_block %}
          <div class="mt-6 md:mt-8" {{ accordion_block.shopify_attributes }}>
            {% render 'product-accordion', product: product %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  class MainProduct {
    constructor(sectionId) {
      this.sectionId = sectionId;
      this.swiper = null;
      this.init();
    }

    init() {
      this.section = document.getElementById(`MainProduct-${this.sectionId}`);
      if (!this.section) return;

      this.mainImage = document.getElementById(`MainImage-${this.sectionId}`);

      let activeBtn = this.section.querySelector('.gallery-thumb-btn[aria-selected="true"]');

      if (!activeBtn) {
        activeBtn = this.section.querySelector('.gallery-thumb-btn');
        if (activeBtn) activeBtn.setAttribute('aria-selected', 'true');
      }

      let startIndex = 0;
      if (activeBtn && activeBtn.dataset.slideIndex) {
        startIndex = parseInt(activeBtn.dataset.slideIndex);
      }

      const swiperContainer = this.section.querySelector('.thumb-swiper');
      if (swiperContainer && typeof Swiper !== 'undefined') {
        this.initSwiper(swiperContainer, startIndex);
      }

      this.section.querySelectorAll('.gallery-thumb-btn').forEach((btn) => {
        btn.addEventListener('click', () => this.handleGalleryClick(btn));
      });

      this.section.querySelectorAll('.variant-radio').forEach((radio) => {
        radio.addEventListener('change', (e) => this.handleVariantChange(e));
      });

      this.section.querySelectorAll('.color-swatch-link').forEach((link) => {
        link.addEventListener('click', (e) => this.handleColorChange(e));
      });
    }

    initSwiper(container, initialIndex) {
      this.swiper = new Swiper(container, {
        slidesPerView: 'auto',
        spaceBetween: 16,
        centeredSlides: true,
        centeredSlidesBounds: true,
        slideToClickedSlide: true,
        initialSlide: initialIndex,
        mousewheel: true,
        direction: 'horizontal',
        breakpoints: {
          768: {
            direction: 'vertical',
            spaceBetween: 24,
            slidesPerView: 'auto',
          },
        },
      });
    }

    handleGalleryClick(btn) {
      if (!this.mainImage) return;

      const allThumbs = this.section.querySelectorAll('.gallery-thumb-btn');
      allThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));
      btn.setAttribute('aria-selected', 'true');

      if (this.swiper) {
        const slideIndex = parseInt(btn.dataset.slideIndex);
        if (!isNaN(slideIndex)) {
          this.swiper.slideTo(slideIndex);
        }
      }

      const newSrc = btn.dataset.src;
      const newSrcset = btn.dataset.srcset;

      if (newSrc) {
        this.mainImage.src = newSrc;
        if (newSrcset) {
          this.mainImage.srcset = newSrcset;
        } else {
          this.mainImage.removeAttribute('srcset');
        }
      }
    }

    handleVariantChange(e) {
      const variantId = e.target.value;
      const url = new URL(window.location);
      url.searchParams.set('variant', variantId);
      window.history.replaceState({}, '', url);

      this.fetchSection(url.toString(), true);
    }

    handleColorChange(e) {
      e.preventDefault();
      const link = e.target.closest('a');
      if (!link) return;

      const url = link.href;
      window.history.pushState({}, '', url);

      this.fetchSection(url, false);
    }

    fetchSection(url, keepImage = false) {
      const fetchUrl = new URL(url);
      fetchUrl.searchParams.set('section_id', this.section.dataset.sectionId);

      this.section.style.opacity = '0.5';

      let currentImageState = null;
      let activeMediaId = null;

      if (keepImage && this.mainImage) {
        currentImageState = {
          src: this.mainImage.src,
          srcset: this.mainImage.srcset,
        };
        const activeBtn = this.section.querySelector('.gallery-thumb-btn[aria-selected="true"]');
        if (activeBtn) {
          activeMediaId = activeBtn.dataset.mediaId;
        }
      }

      fetch(fetchUrl)
        .then((response) => response.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newSectionContent = doc.getElementById(`MainProduct-${this.sectionId}`);

          if (newSectionContent) {
            if (keepImage && currentImageState) {
              const newMainImage = newSectionContent.querySelector(`#MainImage-${this.sectionId}`);
              if (newMainImage) {
                newMainImage.setAttribute('src', currentImageState.src);
                if (currentImageState.srcset) {
                  newMainImage.setAttribute('srcset', currentImageState.srcset);
                } else {
                  newMainImage.removeAttribute('srcset');
                }
              }

              if (activeMediaId) {
                const newThumbs = newSectionContent.querySelectorAll('.gallery-thumb-btn');
                newThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));

                const targetThumb = newSectionContent.querySelector(
                  `.gallery-thumb-btn[data-media-id="${activeMediaId}"]`
                );
                if (targetThumb) {
                  targetThumb.setAttribute('aria-selected', 'true');
                }
              }
            }

            this.section.innerHTML = newSectionContent.innerHTML;
            this.init();
            if (keepImage && activeMediaId && this.swiper) {
              const activeBtn = this.section.querySelector(`.gallery-thumb-btn[data-media-id="${activeMediaId}"]`);
              if (activeBtn) {
                const idx = parseInt(activeBtn.dataset.slideIndex);
                this.swiper.slideTo(idx, 0);
              }
            }

            const variantId = fetchUrl.searchParams.get('variant');
            const radio = document.getElementById(`variant-radio-${variantId}`);
            if (radio) radio.focus();
          }
        })
        .catch((err) => console.error('Error fetching section:', err))
        .finally(() => {
          this.section.style.opacity = '1';
        });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new MainProduct('{{ section.id }}');
  });
</script>

{% schema %}
{
  "name": "Main Product",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show star rating",
      "default": true
    },
    {
      "type": "header",
      "content": "Title Formatting"
    },
    {
      "type": "checkbox",
      "id": "remove_color_from_title",
      "label": "Remove color from title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "remove_color_from_breadcrumbs",
      "label": "Remove color from breadcrumbs",
      "default": true
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "service_text",
      "name": "Service Benefit",
      "settings": [
        {
          "type": "inline_richtext",
          "id": "text",
          "label": "Text",
          "default": "Benefit text here"
        },
        {
          "type": "html",
          "id": "icon_svg",
          "label": "SVG Icon Code",
          "info": "Paste the SVG code here. Ensure it has width/height or viewBox."
        }
      ]
    },
    {
      "type": "accordion_group",
      "name": "Accordion Group",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Renders Size, Notes, and Returns from Metafields."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Main Product"
    }
  ]
}
{% endschema %}

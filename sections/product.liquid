<section class="py-12 bg-background" id="MainProduct-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="container-fluid">
    <nav class="body-medium flex items-center gap-2 text-secondary mb-4" aria-label="Breadcrumb">
      <a href="{{ routes.root_url }}" class="hover:text-foreground transition-colors"> Home </a>
      <span>/</span>
      {% if collection %}
        <a href="{{ collection.url }}" class="hover:text-foreground transition-colors">{{ collection.title }}</a>
        <span>/</span>
      {% endif %}
      <span class="text-foreground cursor-default">{{ product.title }}</span>
    </nav>

    <div class="flex items-stretch gap-6 flex-col md:items-center xl:items-start xl:gap-14 xl:flex-row">
      <div class="flex flex-col-reverse gap-4 shrink-0 md:flex-row md:gap-6">
        <div class="flex gap-4 justify-start overflow-x-auto mr-mobile-thumbnails md:justify-between md:flex-col md:gap-0 md:overflow-x-visible md:mr-0">
          {% for image in product.images %}
            {%- capture main_image_srcset -%}
              {{ image | image_url: width: 375 }} 375w,
              {{ image | image_url: width: 550 }} 550w,
              {{ image | image_url: width: 750 }} 750w,
              {{ image | image_url: width: 1100 }} 1100w,
              {{ image | image_url: width: 1500 }} 1500w
            {%- endcapture -%}

            {% assign is_active = false %}
            {% if product.selected_or_first_available_variant.featured_media.id == image.id %}
              {% assign is_active = true %}
            {% elsif product.selected_or_first_available_variant.featured_media == blank and forloop.first %}
              {% assign is_active = true %}
            {% endif %}

            <button
              class="
                gallery-thumb-btn w-22 h-22 shrink-0 border-none p-0 rounded-lg
                aria-selected:relative
                aria-selected:before:absolute
                aria-selected:before:inset-0
                aria-selected:before:z-10
                aria-selected:before:rounded-lg
                aria-selected:before:bg-foreground/20
              "
              data-src="{{ image.src | image_url: width: 1072 }}"
              data-srcset="{{ main_image_srcset | strip }}"
              data-media-id="{{ image.id }}"
              type="button"
              aria-selected="{{ is_active }}"
            >
              {% assign thumb_image_alt = image.alt
                | default: product.title
                | append: ' - Image '
                | append: forloop.index
                | escape
              %}
              {{
                image
                | image_url: width: 176, height: 176, crop: 'center'
                | image_tag:
                  class: 'w-22 h-22 rounded-lg cursor-pointer',
                  widths: '88, 176',
                  sizes: '88px',
                  loading: 'lazy',
                  alt: thumb_image_alt
              }}
            </button>
          {% endfor %}
        </div>

        <div class="max-w-134 relative w-full">
          {% render 'product-badge', product: product, class: 'absolute top-4 left-4' %}
          {% assign main_image = product.featured_image %}
          {% if main_image != blank %}
            {% assign main_image_id = 'MainImage-' | append: section.id %}
            {% assign image_alt = main_image.alt | default: product.title | default: ' - Selected image' | escape %}
            {{
              main_image
              | image_url: width: 1072, height: 1072, crop: 'center'
              | image_tag:
                id: main_image_id,
                alt: image_alt,
                class: 'max-w-134 w-full rounded-lg aspect-square',
                widths: '320, 375, 450, 536, 640, 750, 900, 1072',
                sizes: '(min-width: 568px) 536px, calc(100vw - 32px - 15px)',
                fetchpriority: 'high'
            }}
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-contain object-center bg-gray-200' }}
          {% endif %}
        </div>
      </div>

      <div class="flex flex-col space-between">
        <div>
          <h1 class="text-h2 mb-2">{{ product.title }}</h1>
          <div class="mb-3">
            <span class="body-medium">★★★★★ 5.0</span>
          </div>
        </div>

        <div class="prose body-medium text-secondary mb-6">
          {{ product.description }}
        </div>

        <div class="body-large flex gap-1.5 mb-6">
          {% if product.selected_or_first_available_variant.compare_at_price
              > product.selected_or_first_available_variant.price
          %}
            <s class="text-secondary">{{ product.selected_or_first_available_variant.compare_at_price | money }}</s>
          {% endif %}
          <span class="text-foreground">{{ product.selected_or_first_available_variant.price | money }}</span>
        </div>

        {% assign product_form_id = 'product-form-' | append: section.id %}
        {% form 'product', product, id: product_form_id, class: 'flex flex-col justify-between' %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          {% assign related_colors = product.metafields.custom.related_colors.value %}
          {% if related_colors != blank %}
            <div class="selector-wrapper mb-6">
              <div class="flex gap-2">
                {% for color_prod in related_colors %}
                  <a
                    href="{{ color_prod.url }}"
                    class="color-swatch-link w-22 h-22 rounded-lg border overflow-hidden transition-all hover:opacity-80 block {% if color_prod.handle == product.handle %} border-foreground {% else %} border-transparent bg-[#F5F5F5] {% endif %}"
                    title="{{ color_prod.title }}"
                  >
                    {% assign color_image_alt = color_prod.featured_image.alt | default: color_prod.title | escape %}
                    {{
                      color_prod.featured_image
                      | image_url: width: 176, height: 176, crop: 'center'
                      | image_tag:
                        class: 'w-22 h-22 rounded-lg pointer-events-none',
                        widths: '88, 176',
                        sizes: '88px',
                        loading: 'lazy',
                        alt: color_image_alt
                    }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% unless product.has_only_default_variant %}
            <div class="selector-wrapper mb-8">
              <div class="flex justify-between items-center mb-3 body-medium">
                <label>Select Size:</label>
                <button type="button" class="underline">Size Guide</button>
              </div>

              {% liquid
                assign size_index = 0
                for option in product.options
                  assign option_downcased = option | downcase
                  if option_downcased contains 'size' or option_downcased contains 'розмір'
                    assign size_index = forloop.index0
                  endif
                endfor
              %}

              <div class="grid gap-2 grid-cols-2 md:grid-cols-3">
                {% for variant in product.variants %}
                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="id"
                      value="{{ variant.id }}"
                      class="peer sr-only variant-radio"
                      {% if product.selected_or_first_available_variant.id == variant.id %}
                        checked
                      {% endif %}
                      {% unless variant.available %}
                        disabled
                      {% endunless %}
                    >
                    <div class="border border-border rounded-md py-3 text-center text-sm font-medium hover:border-black peer-checked:border-black peer-checked:bg-black peer-checked:text-white transition-all peer-disabled:opacity-50 peer-disabled:bg-gray-100 peer-disabled:cursor-not-allowed">
                      {{ variant.options[size_index] }}
                    </div>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endunless %}

          <div class="mt-4">
            <button
              type="submit"
              name="add"
              class="flex items-center justify-center w-full bg-btn text-btn-text border border-btn-border py-4 px-8 text-sm font-medium hover:opacity-90 transition-opacity uppercase disabled:opacity-50 disabled:cursor-not-allowed"
              {% unless product.selected_or_first_available_variant.available %}
                disabled
              {% endunless %}
            >
              {% if product.selected_or_first_available_variant.available %}Add to Bag{% else %}Sold Out{% endif %}
            </button>
          </div>
        {% endform %}
      </div>
    </div>
  </div>
</section>

<script>
  class MainProduct {
    constructor(sectionId) {
      this.sectionId = sectionId;
      this.init();
    }

    init() {
      this.section = document.getElementById(`MainProduct-${this.sectionId}`);
      if (!this.section) return;

      this.mainImage = document.getElementById(`MainImage-${this.sectionId}`);

      this.section.querySelectorAll('.gallery-thumb-btn').forEach((btn) => {
        btn.addEventListener('click', () => this.handleGalleryClick(btn));
      });

      this.section.querySelectorAll('.variant-radio').forEach((radio) => {
        radio.addEventListener('change', (e) => this.handleVariantChange(e));
      });

      this.section.querySelectorAll('.color-swatch-link').forEach((link) => {
        link.addEventListener('click', (e) => this.handleColorChange(e));
      });
    }

    handleGalleryClick(btn) {
      if (!this.mainImage) return;

      const allThumbs = this.section.querySelectorAll('.gallery-thumb-btn');
      allThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));
      btn.setAttribute('aria-selected', 'true');

      const newSrc = btn.dataset.src;
      const newSrcset = btn.dataset.srcset;

      if (newSrc) {
        this.mainImage.src = newSrc;
        if (newSrcset) {
          this.mainImage.srcset = newSrcset;
        } else {
          this.mainImage.removeAttribute('srcset');
        }
      }
    }

    handleVariantChange(e) {
      const variantId = e.target.value;
      const url = new URL(window.location);
      url.searchParams.set('variant', variantId);
      window.history.replaceState({}, '', url);

      this.fetchSection(url.toString(), true);
    }

    handleColorChange(e) {
      e.preventDefault();
      const link = e.target.closest('a');
      if (!link) return;

      const url = link.href;
      window.history.pushState({}, '', url);

      this.fetchSection(url, false);
    }

    fetchSection(url, keepImage = false) {
      const fetchUrl = new URL(url);
      fetchUrl.searchParams.set('section_id', this.section.dataset.sectionId);

      this.section.style.opacity = '0.5';

      let currentImageState = null;
      let activeMediaId = null;

      if (keepImage && this.mainImage) {
        currentImageState = {
          src: this.mainImage.src,
          srcset: this.mainImage.srcset,
        };
        const activeBtn = this.section.querySelector('.gallery-thumb-btn[aria-selected="true"]');
        if (activeBtn) {
          activeMediaId = activeBtn.dataset.mediaId;
        }
      }

      fetch(fetchUrl)
        .then((response) => response.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newSectionContent = doc.getElementById(`MainProduct-${this.sectionId}`);

          if (newSectionContent) {
            if (keepImage && currentImageState) {
              const newMainImage = newSectionContent.querySelector(`#MainImage-${this.sectionId}`);
              if (newMainImage) {
                newMainImage.setAttribute('src', currentImageState.src);
                if (currentImageState.srcset) {
                  newMainImage.setAttribute('srcset', currentImageState.srcset);
                } else {
                  newMainImage.removeAttribute('srcset');
                }
              }

              if (activeMediaId) {
                const newThumbs = newSectionContent.querySelectorAll('.gallery-thumb-btn');
                newThumbs.forEach((thumb) => thumb.setAttribute('aria-selected', 'false'));

                const targetThumb = newSectionContent.querySelector(
                  `.gallery-thumb-btn[data-media-id="${activeMediaId}"]`
                );
                if (targetThumb) {
                  targetThumb.setAttribute('aria-selected', 'true');
                }
              }
            }

            this.section.innerHTML = newSectionContent.innerHTML;
            this.init();
          }
        })
        .catch((err) => console.error('Error fetching section:', err))
        .finally(() => {
          this.section.style.opacity = '1';
        });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new MainProduct('{{ section.id }}');
  });
</script>

{% schema %}
{
  "name": "Main Product",
  "settings": [],
  "presets": [
    {
      "name": "Main Product"
    }
  ]
}
{% endschema %}

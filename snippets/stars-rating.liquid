{% comment %}
  Props:
  - type: 'average' | 'single'
  - product: Product (required if type == 'average')
  - rating: Number (required if type == 'single')
  - show_text: Boolean
  - unique_id: String (optional, for SVG uniqueness)
{% endcomment %}

{% liquid
  assign rating_value = 0
  assign count = 0

  if type == 'average'
    assign reviews_data = product.metafields.custom.reviews_json.value
    if reviews_data != blank
      assign count = reviews_data.size
      assign total_sum = 0
      for r in reviews_data
        assign total_sum = total_sum | plus: r.rating
      endfor
      if count > 0
        assign rating_value = total_sum | times: 1.0 | divided_by: count | round: 1
      endif
    endif

  elsif type == 'single'
    assign rating_value = rating
  endif
  assign gid = 'grad-' | append: unique_id | append: '-' | append: rating_value | replace: '.', '-'
%}

<div class="flex gap-1 text-foreground" title="{{ rating_value }} out of 5">
  <svg width="0" height="0" style="position: absolute; width: 0; height: 0; overflow: hidden; visibility: hidden;">
    <defs>
      <linearGradient id="{{ gid }}" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="50%" stop-color="var(--color-foreground)" />
        <stop offset="50%" stop-color="transparent" />
      </linearGradient>
    </defs>
  </svg>

  <div class="flex gap-0.5">
    {% for i in (1..5) %}
      {% liquid
        assign fill_color = 'transparent'
        assign threshold = i | minus: 0.5

        if rating_value >= i
          assign fill_color = 'var(--color-foreground)'

        elsif rating_value >= threshold
          assign fill_color = 'url(#' | append: gid | append: ')'
        endif
      %}

      {% render 'icon-star', fill: fill_color, stroke: 'var(--color-foreground)' %}
    {% endfor %}
  </div>

  {% if show_text and type == 'average' and count > 0 %}
    <span class="body-medium text-foreground">
      {{ rating_value }}
    </span>
  {% endif %}
</div>
